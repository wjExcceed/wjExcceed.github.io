<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="wjExcceed">



<meta name="description" content="&amp;emsp;&amp;emsp;最近在开发调试过程中出现了一个java.io.IOException:Stream Closed的错误，而这个错误隐藏的比较好，因为它不涉及到主要的流程，只是在通知邮件的时候出现了这么一个异常，所以直到测试人员介入的时候才发现了这一个隐藏的IOException。">
<meta name="keywords" content="fix bug">
<meta property="og:type" content="article">
<meta property="og:title" content="HttpEntity出现的java.io.IOException:Stream Closed">
<meta property="og:url" content="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/index.html">
<meta property="og:site_name" content="巴扎嘿的博客">
<meta property="og:description" content="&amp;emsp;&amp;emsp;最近在开发调试过程中出现了一个java.io.IOException:Stream Closed的错误，而这个错误隐藏的比较好，因为它不涉及到主要的流程，只是在通知邮件的时候出现了这么一个异常，所以直到测试人员介入的时候才发现了这一个隐藏的IOException。">
<meta property="og:locale" content="default">
<meta property="og:image" content="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/stream_closed.JPG">
<meta property="og:image" content="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/HttpEntity的getContent.JPG">
<meta property="og:updated_time" content="2019-07-15T02:16:33.362Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HttpEntity出现的java.io.IOException:Stream Closed">
<meta name="twitter:description" content="&amp;emsp;&amp;emsp;最近在开发调试过程中出现了一个java.io.IOException:Stream Closed的错误，而这个错误隐藏的比较好，因为它不涉及到主要的流程，只是在通知邮件的时候出现了这么一个异常，所以直到测试人员介入的时候才发现了这一个隐藏的IOException。">
<meta name="twitter:image" content="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/stream_closed.JPG">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="巴扎嘿的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>HttpEntity出现的java.io.IOException:Stream Closed | 巴扎嘿的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">wjExcceed</a></h1>
        </hgroup>

        
        <p class="header-subtitle">a newbie&#39;s blog</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OAuth/">OAuth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Operating-System/">Operating System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fix-bug/">fix bug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programing/">programing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/record/">record</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">wjExcceed</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">wjExcceed</a></h1>
            </hgroup>
            
            <p class="header-subtitle">a newbie&#39;s blog</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-HttpEntity出现的java-io-IOException-Stream-Closed" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/" class="article-date">
      <time datetime="2017-08-18T02:24:18.000Z" itemprop="datePublished">2017-08-18</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      HttpEntity出现的java.io.IOException:Stream Closed
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/日常点滴/">日常点滴</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fix-bug/">fix bug</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&emsp;&emsp;最近在开发调试过程中出现了一个java.io.IOException:Stream Closed的错误，而这个错误隐藏的比较好，因为它不涉及到主要的流程，只是在通知邮件的时候出现了这么一个异常，所以直到测试人员介入的时候才发现了这一个隐藏的IOException。<br><a id="more"></a></p>
<img src="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/stream_closed.JPG" title="stream_closed">
<p>下面就来看看这个异常是怎么产生的：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (int i = 0; i &lt; batch; i++) &#123;</span><br><span class="line">               <span class="keyword">List</span>&lt;HashMap&lt;String, String&gt;&gt; sub = performances.subList(100 * i, Math.<span class="built_in">min</span>(100 * (i + 1), performances.size()));</span><br><span class="line">               HashMap&lt;String, Object&gt; json = new HashMap&lt;&gt;();</span><br><span class="line">               json.put(<span class="string">"userId"</span>, user);</span><br><span class="line">               json.put(<span class="string">"sign"</span>, sign);</span><br><span class="line">               json.put(<span class="string">"type"</span>, <span class="string">"year"</span>);</span><br><span class="line">               json.put(<span class="string">"list"</span>, sub);</span><br><span class="line">               CloseableHttpResponse response = null;</span><br><span class="line">               try &#123;</span><br><span class="line">                   response = HttpClientUtil.postJson(url, JSON.toJSONString(json), 30 * 1000, 30 * 1000, 30 * 1000);</span><br><span class="line">                   <span class="keyword">if</span> (response != null &amp;&amp; response.getStatusLine().getStatusCode() == HttpStatus.SC_OK) &#123;                   </span><br><span class="line">                       JSONObject jsonObject = JSON.parseObject(EntityUtils.<span class="keyword">toString</span>(response.getEntity(), Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">                       String code = jsonObject.getString(<span class="string">"code"</span>);</span><br><span class="line">                       <span class="keyword">List</span>&lt;Integer&gt; subIds = ids.subList(100 * i, Math.<span class="built_in">min</span>(100 * (i + 1), performances.size()));</span><br><span class="line">                       <span class="keyword">if</span> (!<span class="string">"200"</span>.equals(code)) &#123;</span><br><span class="line">                           sendFailMail(subIds, <span class="string">""</span>,返回code非200<span class="string">",response != null ? EntityUtils.toString(response.getEntity(), Charset.forName("</span>UTF-8<span class="string">")) : "</span>空");</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="keyword">List</span>&lt;Integer&gt; subIds = ids.subList(100 * i, Math.<span class="built_in">min</span>(100 * (i + 1), performances.size()));</span><br><span class="line">                       sendFailMail(subIds, <span class="string">""</span>,response != null ? EntityUtils.<span class="keyword">toString</span>(response.getEntity(), Charset.forName(<span class="string">"UTF-8"</span>)) : <span class="string">"空"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; catch (Exception <span class="keyword">e</span>) &#123;</span><br><span class="line">                   <span class="keyword">log</span>.<span class="keyword">error</span>(<span class="string">""</span>, <span class="keyword">e</span>);</span><br><span class="line">                   <span class="keyword">List</span>&lt;Integer&gt; subIds = ids.subList(100 * i, Math.<span class="built_in">min</span>(100 * (i + 1), performances.size()));</span><br><span class="line">                   sendFailMail(subIds, <span class="string">""</span>, response != null ? EntityUtils.<span class="keyword">toString</span>(response.getEntity(), Charset.forName(<span class="string">"UTF-8"</span>)) : <span class="string">"空"</span>);</span><br><span class="line">                   throw <span class="keyword">e</span>;</span><br><span class="line">               &#125; finally &#123;</span><br><span class="line">                   <span class="keyword">if</span> (response != null) &#123;</span><br><span class="line">                       response.<span class="keyword">close</span>();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当通过打断点进行定位的时候发现这个异常出现在这个循环体中，再进一步定位发现问题出现在：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="string">"200"</span>.<span class="keyword">equals</span>(code)) </span><br><span class="line">&#123;</span><br><span class="line">sendFailMail(subIds, <span class="string">""</span>,返回code非<span class="number">200</span><span class="string">",response != null ? EntityUtils.toString(response.getEntity(), Charset.forName("</span>UTF<span class="number">-8</span><span class="string">")) : "</span>空<span class="string">");</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>于是进入到EntityUtils.toString(response.getEntity(), Charset.forName(“UTF-8”))这个方法中去看EntityUtils方法的实现,这是httpcore-4.4.4.jar的下org.apache.http.util.EntityUtils.class方法<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> toString(HttpEntity entity, Charset defaultCharset) <span class="keyword">throws</span> IOException, ParseException &#123;</span><br><span class="line">        Args.notNull(entity, <span class="string">"Entity"</span>);</span><br><span class="line">        InputStream instream = entity.getContent();</span><br><span class="line">        <span class="keyword">if</span>(instream == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Args.check(entity.getContentLength() &lt;= <span class="number">2147483647</span>L, <span class="string">"HTTP entity too large to be buffered in memory"</span>);</span><br><span class="line">                <span class="built_in">int</span> i = (<span class="built_in">int</span>)entity.getContentLength();</span><br><span class="line">                <span class="keyword">if</span>(i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    i = <span class="number">4096</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Charset charset = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ContentType contentType = ContentType.<span class="built_in">get</span>(entity);</span><br><span class="line">                    <span class="keyword">if</span>(contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        charset = contentType.getCharset();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (UnsupportedCharsetException var13) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(defaultCharset == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedEncodingException(var13.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    charset = defaultCharset;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    charset = HTTP.DEF_CONTENT_CHARSET;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Reader reader = <span class="keyword">new</span> InputStreamReader(instream, charset);</span><br><span class="line">                CharArrayBuffer buffer = <span class="keyword">new</span> CharArrayBuffer(i);</span><br><span class="line">                <span class="built_in">char</span>[] tmp = <span class="keyword">new</span> <span class="built_in">char</span>[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">                <span class="built_in">int</span> l;</span><br><span class="line">                <span class="keyword">while</span>((l = reader.read(tmp)) != <span class="number">-1</span>) &#123;</span><br><span class="line">                    buffer.<span class="built_in">append</span>(tmp, <span class="number">0</span>, l);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">String</span> var9 = buffer.toString();</span><br><span class="line">                <span class="keyword">return</span> var9;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                instream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出确实是在这个方法中会抛出IOException，而且问题应该就出现在finally方法块的instream.close()上，既然改不了httpcore-4.4.4.jar下的文件，那么肯定是原先的代码中调用的方式不对。</p>
<p>回到源代码中发现这个方法在<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">JSONObject </span><span class="keyword">jsonObject </span>= <span class="keyword">JSON.parseObject(EntityUtils.toString(response.getEntity(), </span>Charset.forName(<span class="string">"UTF-8"</span>)))<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>调用过一次，而在<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="string">"200"</span>.<span class="keyword">equals</span>(code)) </span><br><span class="line">&#123;</span><br><span class="line">sendFailMail(subIds, <span class="string">""</span>,返回code非<span class="number">200</span><span class="string">",response != null ? EntityUtils.toString(response.getEntity(), Charset.forName("</span>UTF<span class="number">-8</span><span class="string">")) : "</span>空<span class="string">");</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>又调用了一次。</p>
<p>接着去网上搜索了一下HttpEntity的这个方法</p>
<p><a href="https://hc.apache.org/httpcomponents-core-ga/httpcore/apidocs/org/apache/http/HttpEntity.html" target="_blank" rel="noopener">HttpEntity Apache HttpCore 4.4.6 API</a></p>
<img src="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/HttpEntity的getContent.JPG" title="HttpEntity的getContent">
<p>在getContent()方法下有这么一句话<br><strong><br>Returns a content stream of the entity. Repeatable entities are expected to create a new instance of InputStream for each invocation of this method and therefore can be consumed multiple times. Entities that are not repeatable are expected to return the same InputStream instance and therefore may not be consumed more than once.
</strong></p>
<p>翻译过来的含义是getContent()方法会返回内容流的一个实体。一个entity可以重复也就意味着通过调用这个方法创建一个新的读入流实例，它的content可以被多次读取，但如果一个entity不可重复，那么它通过调用这个方法只会返回同一个读入流实例，也不能被读取多次。</p>
<p>在这里response.getEntity()方法获得的entity是不可重复的，因此在调用了两次EntityUtils.toString()方法后会出现StreamClosed的错误。</p>
<p>改写后的代码如下,即可避免java.io.IOException:Stream Closed这个异常：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (int i = 0; i &lt; batch; i++) &#123;</span><br><span class="line">               <span class="keyword">List</span>&lt;HashMap&lt;String, String&gt;&gt; sub = performances.subList(100 * i, Math.<span class="built_in">min</span>(100 * (i + 1), performances.size()));</span><br><span class="line">               HashMap&lt;String, Object&gt; json = new HashMap&lt;&gt;();</span><br><span class="line">               json.put(<span class="string">"userId"</span>, user);</span><br><span class="line">               json.put(<span class="string">"sign"</span>, sign);</span><br><span class="line">               json.put(<span class="string">"type"</span>, <span class="string">"year"</span>);</span><br><span class="line">               json.put(<span class="string">"list"</span>, sub);</span><br><span class="line">               CloseableHttpResponse response = null;</span><br><span class="line">               try &#123;</span><br><span class="line">                   response = HttpClientUtil.postJson(url, JSON.toJSONString(json), 30 * 1000, 30 * 1000, 30 * 1000);</span><br><span class="line">                   <span class="keyword">if</span> (response != null &amp;&amp; response.getStatusLine().getStatusCode() == HttpStatus.SC_OK) &#123; </span><br><span class="line">					String temp = EntityUtils.<span class="keyword">toString</span>(response.getEntity(), Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">					JSONObject jsonObject = JSON.parseObject(temp);</span><br><span class="line">                       String code = jsonObject.getString(<span class="string">"code"</span>);</span><br><span class="line">                       <span class="keyword">List</span>&lt;Integer&gt; subIds = ids.subList(100 * i, Math.<span class="built_in">min</span>(100 * (i + 1), performances.size()));</span><br><span class="line">                       <span class="keyword">if</span> (!<span class="string">"200"</span>.equals(code)) &#123;</span><br><span class="line">                           sendFailMail(subIds, <span class="string">""</span>,返回code非200<span class="string">",response != null ? temp : "</span>空");</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="keyword">List</span>&lt;Integer&gt; subIds = ids.subList(100 * i, Math.<span class="built_in">min</span>(100 * (i + 1), performances.size()));</span><br><span class="line">                       sendFailMail(subIds, <span class="string">""</span>,response != null ? EntityUtils.<span class="keyword">toString</span>(response.getEntity(), Charset.forName(<span class="string">"UTF-8"</span>)) : <span class="string">"空"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; catch (Exception <span class="keyword">e</span>) &#123;</span><br><span class="line">                   <span class="keyword">log</span>.<span class="keyword">error</span>(<span class="string">""</span>, <span class="keyword">e</span>);</span><br><span class="line">                   <span class="keyword">List</span>&lt;Integer&gt; subIds = ids.subList(100 * i, Math.<span class="built_in">min</span>(100 * (i + 1), performances.size()));</span><br><span class="line">                   sendFailMail(subIds, <span class="string">""</span>, response != null ? EntityUtils.<span class="keyword">toString</span>(response.getEntity(), Charset.forName(<span class="string">"UTF-8"</span>)) : <span class="string">"空"</span>);</span><br><span class="line">                   throw <span class="keyword">e</span>;</span><br><span class="line">               &#125; finally &#123;</span><br><span class="line">                   <span class="keyword">if</span> (response != null) &#123;</span><br><span class="line">                       response.<span class="keyword">close</span>();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/">HttpEntity出现的java.io.IOException:Stream Closed</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">wjExcceed</a></p>
        <p><span>发布时间:</span>2017-08-18, 10:24:18</p>
        <p><span>最后更新:</span>2019-07-15, 10:16:33</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/" title="HttpEntity出现的java.io.IOException:Stream Closed">/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/</a>
            <span class="copy-path" data-clipboard-text="原文: /2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/　　作者: wjExcceed" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2017/08/18/关于mina的知识整理/">
                    关于mina的知识整理
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2017/08/16/数据库连接池/">
                    数据库连接池
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"HttpEntity出现的java.io.IOException:Stream Closed　| 巴扎嘿的博客　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function(){
            this.page.url = '/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/';
            this.page.identifier = '2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/';
        };
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = '//[object Object].disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <script> loadComment(); </script>

</section>


    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/08/18/关于mina的知识整理/" title="上一篇: 关于mina的知识整理">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2017/08/16/数据库连接池/" title="下一篇: 数据库连接池">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/15/a/">a</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/28/Java内存模型——JMM/">Java内存模型——JMM</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/20/聊聊操作系统/">聊聊操作系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/20/I-O多路复用/">I/O多路复用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/20/TCP-UDP的归纳总结/">TCP/UDP的归纳总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/19/Cookie-Session机制/">Cookie/Session机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/关于mina的知识整理/">关于mina的知识整理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/HttpEntity出现的java-io-IOException-Stream-Closed/">HttpEntity出现的java.io.IOException:Stream Closed</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/16/数据库连接池/">数据库连接池</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/14/网易秋招笔试题/">网易秋招笔试题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/09/JVM/">JVM梳理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/07/OAuth浅析/">OAuth浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/jdk编年史/">jdk编年史</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/02/java高并发/">java高并发</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/数据库的整理笔记/">数据库的整理笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/31/JIT/">JIT--即时编译</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/29/Computer Network/">数据链路层的要点</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2019 wjExcceed
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>